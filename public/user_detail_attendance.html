<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Attendance Details - Admin Dashboard</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Admin CSS -->
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>

    <!-- Sidebar Container -->
    <div id="sidebar-container"></div>

    <!-- Page Content -->
    <div id="content">
        <!-- Main Content -->
        <!-- Note: Navbar is injected by layout.js at the top of #content -->
        <div id="main-content" class="container-fluid p-4">
            <!-- Back Button -->
            <div class="mb-3">
                <a href="/attendance_user" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to General Attendance
                </a>
            </div>

            <!-- User Profile Header -->
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <div class="avatar me-3" style="width: 60px; height: 60px; font-size: 24px;"
                                    id="user-avatar">
                                    --
                                </div>
                                <div>
                                    <h3 class="mb-1" id="user-email">Loading...</h3>
                                    <div class="text-muted">
                                        <span class="me-3"><i class="fas fa-id-card me-1"></i>NIK: <span
                                                id="user-nik">-</span></span>
                                        <span><i class="fas fa-building me-1"></i>Area: <span
                                                id="user-area">-</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end mt-3 mt-md-0">
                            <!-- Button moved to filter area -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Date Range Filter -->
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-body">
                    <form id="filter-form" class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="startDate" class="form-label fw-bold small">Start Date</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-3">
                            <label for="endDate" class="form-label fw-bold small">End Date</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                        <div class="col-md-6 d-flex gap-2">
                            <button type="button" id="btn-filter" class="btn btn-primary flex-fill">
                                <i class="fas fa-filter me-2"></i>Filter
                            </button>
                            <button type="button" id="btn-reset" class="btn btn-outline-secondary flex-fill">
                                <i class="fas fa-undo me-2"></i>Reset
                            </button>
                            <button type="button" id="btn-export" class="btn btn-success flex-fill">
                                <i class="fas fa-file-excel me-2"></i>Export
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Attendance Records Table -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">Attendance History</h5>
                    <div class="table-responsive">
                        <table id="attendance-table" class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Date & Time</th>
                                    <th>Location</th>
                                    <th>Photo</th>
                                    <th>Accuracy</th>
                                    <th>Maps</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via API -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Layout JS -->
    <script src="js/api.js"></script>
    <script src="js/layout.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("=== Page Loaded ===");

            // Initialize Layout with active page
            renderLayout('user_detail_attendance');

            // Get user email from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const userEmail = urlParams.get('email');
            console.log("User email from URL:", userEmail);

            if (!userEmail) {
                alert('No user specified. Redirecting to general attendance.');
                window.location.href = '/attendance_user';
                return;
            }

            // Store user email for later use
            window.currentUserEmail = userEmail;

            // Fetch user details from /users/{email}
            fetchUserDetails(userEmail);

            console.log("=== Initializing DataTable ===");
            // Initialize DataTable with API Configuration
            const table = initDataTable('#attendance-table', {
                dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                    "<'row'<'col-sm-12'tr>>" +
                    "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>B",
                buttons: [
                    {
                        extend: 'excel',
                        text: '<i class="fas fa-file-excel me-2"></i>Export to Excel',
                        className: 'btn btn-success d-none',
                        title: `Attendance Report - ${userEmail}`,
                        filename: function () {
                            const startDate = document.getElementById('startDate').value;
                            const endDate = document.getElementById('endDate').value;
                            let filename = `Attendance_${userEmail.replace('@', '_')}`;
                            if (startDate && endDate) {
                                filename += `_${startDate}_to_${endDate}`;
                            } else if (startDate) {
                                filename += `_from_${startDate}`;
                            } else if (endDate) {
                                filename += `_until_${endDate}`;
                            }
                            return filename;
                        },
                        exportOptions: {
                            columns: [0, 1, 2, 4], // Export row#, date, location, and accuracy (exclude photo and maps)
                            modifier: {
                                search: 'applied',
                                order: 'applied'
                            }
                        }
                    }
                ],
                ajax: function (data, callback, settings) {
                    console.log("=== Building AJAX URL ===");
                    // Build URL with email as path parameter
                    let url = API_CONFIG.endpoints.recentAttendance + '/' + encodeURIComponent(userEmail);
                    console.log("Base URL: ", url);
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    console.log("Final URL: ", url);

                    // Build payload with date filters in the body (not query params)
                    const payload = {
                        refreshToken: localStorage.getItem('refreshToken')
                    };

                    // Add date filters to request body if present
                    if (startDate) {
                        payload.startDate = startDate;
                    }
                    if (endDate) {
                        payload.endDate = endDate;
                    }

                    console.log("Request payload:", payload);

                    // Make the AJAX request
                    $.ajax({
                        url: url,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(payload),
                        success: function (response) {
                            console.log("=== AJAX Success ===");
                            console.log("Response:", response);
                            callback({
                                data: response.data || response
                            });
                        },
                        error: function (xhr, error, thrown) {
                            console.error("=== AJAX Error ===");
                            console.error("Status:", xhr.status);
                            console.error("Error:", error);
                            console.error("Thrown:", thrown);
                            console.error("Response:", xhr.responseText);
                            callback({
                                data: []
                            });
                        }
                    });
                },
                columns: [
                    {
                        data: null,
                        searchable: false,
                        render: function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    {
                        data: 'timestamp',
                        render: function (data, type, row) {
                            if (!data) return '';
                            // Input: 2025-12-12 11-16-20
                            // Desired: 2025-12-12 11:16 AM

                            const parts = data.split(' ');
                            if (parts.length < 2) return data;

                            const datePart = parts[0];
                            const timePart = parts[1].replace(/-/g, ':'); // 11:16:20

                            const [hoursStr, minutesStr] = timePart.split(':');
                            let hours = parseInt(hoursStr);
                            const ampm = hours >= 12 ? 'PM' : 'AM';
                            hours = hours % 12;
                            hours = hours ? hours : 12; // the hour '0' should be '12'

                            return `${datePart} ${hours}:${minutesStr} ${ampm}`;
                        }
                    },
                    {
                        data: 'caption',
                        render: function (data, type, row) {
                            return data || '<span class="text-muted">-</span>';
                        }
                    },
                    {
                        data: 'photo',
                        orderable: false,
                        render: function (data, type, row) {
                            if (!data) return '<span class="text-muted">No Photo</span>';
                            return `
                                <img src="${API_CONFIG.getPhotoUrl(data)}" 
                                     alt="Attendance Photo" 
                                     class="rounded" 
                                     width="50" 
                                     height="50"
                                     style="object-fit: cover; cursor: pointer;"
                                     onclick="window.open('${API_CONFIG.getPhotoUrl(data)}', '_blank')">
                            `;
                        }
                    },
                    {
                        data: 'accuracy',
                        render: function (data, type, row) {
                            if (!data) return '<span class="text-muted">-</span>';
                            const accuracy = parseFloat(data);
                            let badgeClass = 'bg-success';
                            if (accuracy < 20) badgeClass = 'bg-danger';
                            else if (accuracy < 50) badgeClass = 'bg-warning';
                            return `<span class="badge ${badgeClass} rounded-pill">${accuracy.toFixed(1)}m</span>`;
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        render: function (data, type, row) {
                            if (row.latitude && row.longitude) {
                                return `
                                    <a href="https://www.google.com/maps?q=${row.latitude},${row.longitude}" 
                                       target="_blank" 
                                       class="btn btn-sm btn-outline-primary" 
                                       title="View on Map">
                                        <i class="fas fa-location-dot"></i>
                                    </a>
                                `;
                            }
                            return '<span class="text-muted small">No Location</span>';
                        }
                    }
                ],
                order: [[0, 'desc']] // Sort by date descending (newest first)
            });

            // Date range validation
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');

            startDateInput.addEventListener('change', function () {
                if (this.value) {
                    endDateInput.min = this.value;
                    if (endDateInput.value && endDateInput.value < this.value) {
                        endDateInput.value = '';
                    }
                } else {
                    endDateInput.min = '';
                }
            });

            endDateInput.addEventListener('change', function () {
                if (startDateInput.value && this.value < startDateInput.value) {
                    alert('End date cannot be before start date');
                    this.value = '';
                }
            });

            // Filter functionality
            document.getElementById('btn-filter').addEventListener('click', function () {
                $('#attendance-table').DataTable().ajax.reload();
            });

            // Reset functionality
            document.getElementById('btn-reset').addEventListener('click', function () {
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                endDateInput.min = ''; // Reset min constraint
                $('#attendance-table').DataTable().ajax.reload();
            });

            // Export to Excel functionality
            document.getElementById('btn-export').addEventListener('click', function () {
                $('#attendance-table').DataTable().button(0).trigger();
            });

            // Function to fetch user details
            async function fetchUserDetails(email) {
                try {
                    const response = await fetch(`${API_CONFIG.endpoints.users}/${encodeURIComponent(email)}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            refreshToken: localStorage.getItem('refreshToken')
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch user details');
                    }

                    const userData = await response.json();

                    // Update user profile header
                    document.getElementById('user-email').textContent = userData.email || email;
                    document.getElementById('user-avatar').textContent = (userData.email || email).substring(0, 2).toUpperCase();
                    document.getElementById('user-nik').textContent = userData.nik || '-';
                    document.getElementById('user-area').textContent = userData.status || '-';
                } catch (error) {
                    console.error('Error fetching user details:', error);
                    // Fallback to email from URL
                    document.getElementById('user-email').textContent = email;
                    document.getElementById('user-avatar').textContent = email.substring(0, 2).toUpperCase();
                }
            }
        });
    </script>
</body>

</html>