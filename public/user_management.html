<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Admin Dashboard</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Admin CSS -->
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>

    <!-- Sidebar Container -->
    <div id="sidebar-container"></div>

    <!-- Page Content -->
    <div id="content">
        <!-- Main Content -->
        <!-- Note: Navbar is injected by layout.js at the top of #content -->
        <div id="main-content" class="container-fluid p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>User Management</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal"
                    onclick="prepareAddUser()">
                    <i class="fas fa-plus me-2"></i>Add User
                </button>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="users-table" class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>No</th>
                                    <th>Email</th>
                                    <th>Nama</th>
                                    <th>Nomor Induk Karyawan</th>
                                    <th>Role</th>
                                    <th>Area Kerja</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via API -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal (Add/Edit) -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalLabel">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="mb-3">
                            <label for="userName" class="form-label">Full Name</label>
                            <input type="text" class="form-label form-control" id="userName" required>
                        </div>
                        <div class="mb-3">
                            <label for="userEmail" class="form-label">Email</label>
                            <input type="email" class="form-label form-control" id="userEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="userNik" class="form-label">NIK (No. Karyawan)</label>
                            <input type="text" class="form-label form-control" id="userNik" required>
                        </div>
                        <div class="mb-3">
                            <label for="userPassword" class="form-label">Password</label>
                            <input type="password" class="form-label form-control" id="userPassword"
                                placeholder="Leave blank to keep current password">
                            <small class="text-muted" id="passwordHelp">Required for new users.</small>
                        </div>
                        <div class="mb-3">
                            <label for="userStatus" class="form-label">Site</label>
                            <select class="form-select" id="userStatus" required>
                                <option value="Site TB">Site TB</option>
                                <option value="Site BMP">Site BMP</option>
                                <option value="HO">Head Office</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="userRole" class="form-label">Role</label>
                            <select class="form-select" id="userRole" required>
                                <option value="admin">admin</option>
                                <option value="user">user</option>
                                <option value="hcga">hcga</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveUserBtn" onclick="handleSaveUser()">Save
                        User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this user?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Layout JS -->
    <script src="js/api.js"></script>
    <script src="js/layout.js"></script>
    <script>
        let usersTable;
        let selectedUserId = null;

        document.addEventListener("DOMContentLoaded", function () {
            // Initialize Layout
            renderLayout('user_management');

            // Initialize DataTable
            usersTable = initDataTable('#users-table', {
                ajax: {
                    url: API_CONFIG.endpoints.users,
                    type: 'POST',
                    contentType: 'application/json',
                    data: function (d) {
                        return JSON.stringify({
                            refreshToken: localStorage.getItem('refreshToken')
                        });
                    },
                    dataSrc: ''
                },
                columns: [
                    {
                        data: null,
                        render: function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    {
                        data: 'email',
                        render: function (data, type, row) {
                            const initials = data ? data.substring(0, 2).toUpperCase() : '??';
                            return `
                                <div class="d-flex align-items-center">
                                    <div class="avatar me-3">${initials}</div>
                                    <div>
                                        <p class="mb-0 fw-bold">${data || 'Unknown'}</p>
                                        <small class="text-muted">${row.email || ''}</small>
                                    </div>
                                </div>
                            `;
                        }
                    },
                    { data: 'name' },
                    { data: 'nik' },
                    { data: 'role' },
                    {
                        data: 'status',
                        render: function (data) {
                            const badgeClass = data === 'active' ? 'bg-success' : 'bg-secondary';
                            return `<span class="badge ${badgeClass} rounded-pill">${data}</span>`;
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        render: function (data, type, row) {
                            return `
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="prepareEditUser(${JSON.stringify(row).replace(/"/g, '&quot;')})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(${row.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                        }
                    }
                ]
            });
        });

        function prepareAddUser() {
            selectedUserId = null;
            document.getElementById('userModalLabel').innerText = 'Add New User';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userPassword').required = true;
            document.getElementById('passwordHelp').innerText = 'Required for new users.';
        }

        function prepareEditUser(user) {
            selectedUserId = user.id;
            document.getElementById('userModalLabel').innerText = 'Edit User';
            document.getElementById('userId').value = user.id;
            document.getElementById('userName').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userNik').value = user.nik;
            document.getElementById('userStatus').value = user.status || 'active';
            document.getElementById('userPassword').required = false;
            document.getElementById('passwordHelp').innerText = 'Leave blank to keep current password.';

            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        }

        async function handleSaveUser() {
            console.log('selected user id', selectedUserId);
            const form = document.getElementById('userForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const userData = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                nik: document.getElementById('userNik').value,
                status: document.getElementById('userStatus').value,
                role: document.getElementById('userRole').value
            };

            const password = document.getElementById('userPassword').value;
            if (password) userData.password = password;

            const isEdit = !!selectedUserId;
            const url = isEdit ? `${API_CONFIG.endpoints.users}/${selectedUserId}` : API_CONFIG.endpoints.registeruser;
            const method = isEdit ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...userData,
                        refreshToken: localStorage.getItem('refreshToken')
                    })
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                    location.reload(); // Simplest way to refresh DataTable
                } else if (response.status === 403) {
                    performLogout();
                } else {
                    alert('Failed to save user');
                }
            } catch (error) {
                console.error('Error saving user:', error);
                alert('An error occurred while saving user');
            }
        }

        function confirmDelete(userId) {
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            document.getElementById('confirmDeleteBtn').onclick = async function () {
                try {
                    const response = await fetch(`${API_CONFIG.endpoints.users}/${userId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            refreshToken: localStorage.getItem('refreshToken')
                        })
                    });
                    if (response.ok) {
                        deleteModal.hide();
                        location.reload();
                    } else if (response.status === 403) {
                        performLogout();
                    } else {
                        alert('Failed to delete user');
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('An error occurred while deleting user');
                }
            };
            deleteModal.show();
        }
    </script>
</body>

</html>