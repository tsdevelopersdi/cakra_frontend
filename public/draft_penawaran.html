<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table Penawaran - Admin Dashboard</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Admin CSS -->
    <link rel="stylesheet" href="css/admin.css">
    <style>
        .card-table {
            border-radius: 12px;
            overflow: hidden;
        }

        .table-penawaran thead th {
            background-color: #f8f9fa;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            font-weight: 700;
        }

        .loading-overlay {
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>

<body>

    <!-- Sidebar Container -->
    <div id="sidebar-container"></div>

    <!-- Page Content -->
    <div id="content">
        <!-- Main Content -->
        <div id="main-content" class="container-fluid p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold"><i class="fas fa-file-invoice text-primary me-2"></i>Table Penawaran</h2>
            </div>

            <!-- Top Control Panel -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body py-3 d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-project-diagram fa-2x text-primary me-3 text-opacity-50"></i>
                        <div>
                            <h5 class="mb-0" id="project-title-display">Project Configuration</h5>
                            <p class="text-muted small mb-0" id="project-info-display">Select a project to generate
                                offer table</p>
                        </div>
                    </div>
                    <div>
                        <button id="btn-load-project" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#loadProjectModal">
                            <i class="fas fa-search me-1"></i> Load Project
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Display Area -->
            <div class="card border-0 shadow-sm card-table">
                <div class="card-body p-0">
                    <!-- Empty State -->
                    <div id="penawaran-empty" class="text-center py-5 text-muted">
                        <i class="fas fa-table fa-3x mb-3 opacity-25"></i>
                        <p>Select a project to view the data table.</p>
                    </div>

                    <!-- Loading State -->
                    <div id="penawaran-loading" class="loading-overlay d-none">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted">Fetching project data...</p>
                    </div>

                    <!-- Result Table -->
                    <div id="penawaran-content" class="d-none">
                        <div class="table-responsive">
                            <table class="table table-hover table-penawaran align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 50px;">No</th>
                                        <th>Item Description</th>
                                        <th>Specification</th>
                                        <th class="text-center">Qty</th>
                                        <th class="text-center">Unit</th>
                                        <th class="text-end">Unit Price</th>
                                        <th class="text-end">Total Price</th>
                                    </tr>
                                </thead>
                                <tbody id="penawaran-tbody">
                                    <!-- Populated via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Load Project -->
    <div class="modal fade" id="loadProjectModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-list me-2"></i>Select Project</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">#</th>
                                    <th>Project Name</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="modal-project-tbody">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                                        Loading projects...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/layout.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Render sidebar
            renderLayout('table_penawaran');

            const btnLoadProject = document.getElementById('btn-load-project');
            const projectTbody = document.getElementById('modal-project-tbody');
            const emptyState = document.getElementById('penawaran-empty');
            const loadingState = document.getElementById('penawaran-loading');
            const resultContent = document.getElementById('penawaran-content');
            const tableTbody = document.getElementById('penawaran-tbody');
            const displayTitle = document.getElementById('project-title-display');
            const displayInfo = document.getElementById('project-info-display');

            // --- API Logic ---
            async function fetchProjects() {
                try {
                    const response = await fetch(API_CONFIG.endpoints.projects, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('refreshToken')}`
                        }
                    });

                    if (response.ok) {
                        const projects = await response.json();
                        const data = projects.data || projects;

                        projectTbody.innerHTML = data.map((p, i) => `
                            <tr>
                                <td class="ps-3">${i + 1}</td>
                                <td><b>${p.project_name}</b></td>
                                <td>${p.customer || '-'}</td>
                                <td><small class="text-muted">${new Date(p.created_at).toLocaleDateString()}</small></td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-primary btn-select-project" 
                                        data-name="${p.project_name}" 
                                        data-id="${p.id}">
                                        Select
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        projectTbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load projects</td></tr>';
                    }
                } catch (error) {
                    projectTbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error connecting to server</td></tr>';
                }
            }

            // --- Interaction Logic ---
            document.getElementById('loadProjectModal').addEventListener('show.bs.modal', fetchProjects);

            projectTbody.addEventListener('click', async function (e) {
                if (e.target.classList.contains('btn-select-project')) {
                    const name = e.target.dataset.name;
                    const id = e.target.dataset.id;

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('loadProjectModal'));
                    modal.hide();

                    // Show Loading
                    emptyState.classList.add('d-none');
                    resultContent.classList.add('d-none');
                    loadingState.classList.remove('d-none');

                    // Update UI
                    displayTitle.textContent = name;
                    displayInfo.textContent = `Project ID: ${id} | Fetching items...`;

                    // Fetch Real Data from API
                    await fetchProjectData(name, id);
                }
            });

            async function fetchProjectData(projectName, projectId) {
                try {
                    // Use the new direct endpoint: draftPenawaran/{projectId}
                    const response = await fetch(`${API_CONFIG.endpoints.draftPenawaran}/${projectId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('refreshToken')}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('No draft items found for this project.');
                        }
                        throw new Error('Failed to fetch project data');
                    }

                    const result = await response.json();
                    const items = result.items || [];
                    const totalHarga = result.total_harga || 0;

                    if (!items || items.length === 0) {
                        loadingState.classList.add('d-none');
                        emptyState.classList.remove('d-none');
                        displayInfo.textContent = `Project: ${projectName} | No items found`;
                        return;
                    }

                    // 3. Render items
                    renderTableItems(items, totalHarga);

                    loadingState.classList.add('d-none');
                    resultContent.classList.remove('d-none');
                    displayInfo.textContent = `Project: ${projectName} | Data loaded successfully`;
                    showToast('Project data loaded successfully!', 'success');

                } catch (error) {
                    console.error('Error loading project data:', error);
                    loadingState.classList.add('d-none');
                    emptyState.classList.remove('d-none');
                    showAlert('Info', error.message, 'info');
                }
            }

            function renderTableItems(items, totalHarga) {
                // Render Body
                tableTbody.innerHTML = items.map((item, i) => {
                    const desc = item.nama_panel || item.description || item.name || '-';
                    const spec = item.tipe_ukuran || item.specification || '-';
                    const qty = parseFloat(item.qty || item.quantity || 0);
                    const unit = item.satuan || item.unit || 'pcs';
                    const price = parseFloat(item.harga_setelah_disc_rp || item.price || 0);
                    const total = item.row_total || (qty * price);

                    return `
                        <tr>
                            <td class="text-center">${i + 1}</td>
                            <td><span class="fw-bold text-dark">${desc}</span></td>
                            <td><small class="text-muted">${spec}</small></td>
                            <td class="text-center">${qty}</td>
                            <td class="text-center">${unit}</td>
                            <td class="text-end font-monospace">Rp ${price.toLocaleString('id-ID')}</td>
                            <td class="text-end font-monospace fw-bold text-primary">Rp ${total.toLocaleString('id-ID')}</td>
                        </tr>
                    `;
                }).join('');

                // Render Footer for Total
                const table = tableTbody.closest('table');
                let tfoot = table.querySelector('tfoot');
                if (!tfoot) {
                    tfoot = document.createElement('tfoot');
                    table.appendChild(tfoot);
                }

                tfoot.innerHTML = `
                    <tr class="table-light">
                        <td colspan="6" class="text-end fw-bold py-3">GRAND TOTAL</td>
                        <td class="text-end fw-bold text-primary py-3 font-monospace h5 mb-0">Rp ${totalHarga.toLocaleString('id-ID')}</td>
                    </tr>
                `;
            }
        });
    </script>
</body>

</html>