<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Upload - Admin Dashboard</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Admin CSS -->
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>

    <!-- Sidebar Container -->
    <div id="sidebar-container"></div>

    <!-- Page Content -->
    <div id="content">
        <!-- Main Content -->
        <div id="main-content" class="container-fluid p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Invoice Upload</h2>
            </div>

            <!-- Main Content Row -->
            <div class="row justify-content-center">
                <!-- Center Column: Upload Form -->
                <div class="col-md-6">
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-header bg-white py-3">
                            <h5 class="mb-0 text-primary"><i class="fas fa-file-upload me-2"></i>Upload Invoice Image
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="upload-form">
                                <div class="mb-3">
                                    <label for="invoiceImage" class="form-label">Select Invoice Image</label>
                                    <input class="form-control" type="file" id="invoiceImage" accept="image/*" required>
                                </div>
                                <div class="mb-3 text-center bg-light p-3 rounded"
                                    style="min-height: 200px; display: flex; align-items: center; justify-content: center;">
                                    <span id="preview-placeholder" class="text-muted">Image Preview</span>
                                    <img id="image-preview" src="#" alt="Image Preview"
                                        class="img-fluid d-none border rounded" style="max-height: 300px;">
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary" id="btn-submit-upload">
                                        <i class="fas fa-magic me-2"></i>Extract with AI
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="row justify-content-center mt-4">
                    <div class="col-md-10">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white py-3">
                                <h5 class="mb-0 text-success"><i class="fas fa-history me-2"></i>Recent Uploads</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle" id="invoice-list-table">
                                        <thead class="table-light">
                                            <tr>
                                            <tr>
                                                <th>Invoice Date</th>
                                                <th>Invoice Number</th>
                                                <th>Status</th>
                                                <th>Amount</th>
                                                <th class="text-center">Invoice Picture</th>
                                            </tr>
                                        </thead>
                                        <tbody id="invoice-list-tbody">
                                            <tr>
                                                <td colspan="5" class="text-center py-4">Loading your invoices...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core JS -->
        <script src="js/api.js"></script>
        <script src="js/auth.js"></script>
        <script src="js/layout.js"></script>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // Initialize Layout
                renderLayout('invoice_upload');

                // Initial cleanup
                resetPage();
                fetchInvoiceList();

                function resetPage() {
                    document.getElementById('upload-form').reset();
                    document.getElementById('image-preview').classList.add('d-none');
                    document.getElementById('preview-placeholder').classList.remove('d-none');
                }

                async function fetchInvoiceList() {
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    const tbody = document.getElementById('invoice-list-tbody');

                    if (!user.name || !user.email) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-danger">User session invalid. Please re-login.</td></tr>';
                        return;
                    }

                    try {
                        const params = new URLSearchParams({ name: user.name, email: user.email });
                        const res = await fetch(`${API_CONFIG.endpoints.invoiceList}?${params.toString()}`, {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('refreshToken')}` }
                        });

                        if (res.ok) {
                            const data = await res.json();
                            renderInvoiceList(data);
                        } else {
                            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-warning">Failed to load invoices.</td></tr>';
                        }
                    } catch (e) {
                        console.error('Error fetching invoices:', e);
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-danger">Connection error.</td></tr>';
                    }
                }

                function renderInvoiceList(invoices) {
                    const tbody = document.getElementById('invoice-list-tbody');
                    tbody.innerHTML = '';

                    if (!invoices || invoices.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No invoices uploaded yet.</td></tr>';
                        return;
                    }

                    const badges = {
                        on_review: 'warning',
                        approved: 'success',
                        rejected: 'danger'
                    };

                    invoices.forEach(inv => {
                        const dateData = inv.tanggal_upload || inv.createdAt;
                        const date = dateData ? new Date(dateData).toLocaleDateString('id-ID') : '-';
                        const statusColor = badges[inv.status] || 'secondary';
                        const statusHtml = `<span class="badge bg-${statusColor}">${inv.status || '-'}</span>`;
                        const token = localStorage.getItem('refreshToken');
                        // Use backend API path for image:
                        const imgUrl = inv.nama_invoice ? `${API_CONFIG.endpoints.invoiceDetailImage}/${inv.nama_invoice}` : '#';

                        tbody.insertAdjacentHTML('beforeend', `
                            <tr>
                                <td>${date}</td>
                                <td><strong>${inv.nama_invoice || '-'}</strong></td>
                                <td>${statusHtml}</td>
                                <td>Rp ${parseFloat(inv.total_harga || 0).toLocaleString('id-ID')}</td>
                                <td class="text-center">
                                    <div style="width: 50px; height: 50px; overflow: hidden; border-radius: 4px; margin: 0 auto;">
                                        ${inv.nama_invoice ? `<img src="" data-filename="${inv.nama_invoice}" alt="Invoice" class="invoice-mini-pic" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" onclick="window.location.href='/invoice_detail?id=${inv.id}'">` : '<i class="fas fa-image text-muted" style="line-height: 50px;"></i>'}
                                    </div>
                                </td>
                            </tr>
                        `);
                    });

                    // Fetch images securely with token
                    document.querySelectorAll('.invoice-mini-pic').forEach(img => {
                        const filename = img.getAttribute('data-filename');
                        fetch(`${API_CONFIG.endpoints.invoiceDetailImage}/${filename}`, {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('refreshToken')}` }
                        })
                            .then(res => res.blob())
                            .then(blob => {
                                img.src = URL.createObjectURL(blob);
                            })
                            .catch(e => console.error('Error loading mini image', e));
                    });
                }

                // Image Preview
                const fileInput = document.getElementById('invoiceImage');
                const previewImg = document.getElementById('image-preview');
                const placeholder = document.getElementById('preview-placeholder');

                fileInput.addEventListener('change', function () {
                    const file = this.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = e => {
                            previewImg.src = e.target.result;
                            previewImg.classList.remove('d-none');
                            placeholder.classList.add('d-none');
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // Process AI
                document.getElementById('upload-form').addEventListener('submit', async function (e) {
                    e.preventDefault();
                    const btn = document.getElementById('btn-submit-upload');
                    const file = fileInput.files[0];
                    if (!file) return;

                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';

                    const formData = new FormData();
                    formData.append('file', file);

                    // Include user info
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    if (user.name) formData.append('name', user.name);
                    if (user.email) formData.append('email', user.email);

                    try {
                        console.log('Sending to n8n URL:', N8N_URL_INVOICE);
                        const res = await fetch(N8N_URL_INVOICE, { method: 'POST', body: formData });

                        if (res.ok) {
                            const data = await res.json();
                            console.log('AI Process success:', data);
                            await showAlert('Success', 'Invoice processed successfully by AI.', 'success');
                            resetPage();
                            fetchInvoiceList(); // Refresh list
                        } else {
                            const errorText = await res.text();
                            console.error('n8n error response:', res.status, errorText);
                            throw new Error(`Server returned ${res.status}: ${errorText || 'No detail'}`);
                        }
                    } catch (err) {
                        console.error('Fetch error:', err);
                        showAlert('Connection Error', `Failed to reach n8n: ${err.message}`, 'error');
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-magic me-2"></i>Extract with AI';
                    }
                });
            });
        </script>
</body>

</html>